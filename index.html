<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Asociar Tarjeta - Demo</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: radial-gradient(circle at 20% 20%, #111019 0%, #06060a 45%, #030304 100%);
            font-family: 'VT323', monospace;
            color: #cfd3dc;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
            position: relative;
        }

        #matrix-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; 
            opacity: 0.35;
            pointer-events: none;
        }

        .page-container {
            position: relative; z-index: 10; width: 100%; max-width: 1000px;
            display: flex; flex-direction: column; gap: 20px;
            background: rgba(12, 12, 18, 0.85);
            padding: 25px; border-radius: 20px;
            border: 1px solid rgba(123, 117, 214, 0.3);
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            margin-bottom: 50px;
        }

        .top-bar {
            text-align: center; border-bottom: 1.5px solid #7b75d6;
            padding-bottom: 15px; margin-bottom: 10px;
            font-size: 22px; color: #cfd3dc; text-shadow: 0 0 4px rgba(123, 117, 214, 0.4);
        }
        .blink { animation: blink 1.4s step-start infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        .content-area {
            display: flex; flex-direction: row; gap: 40px;
            align-items: center; justify-content: center;
        }

        .card-wrapper { flex: 1; max-width: 420px; min-width: 300px; }

        .card-visual {
            aspect-ratio: 1.58/1; width: 100%;
            border-radius: 18px; padding: 25px; position: relative;
            display: flex; flex-direction: column; justify-content: space-between;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1.5px solid rgba(123, 117, 214, 0.5);
            box-shadow: 0 0 20px rgba(123, 117, 214, 0.2);
            overflow: hidden; transition: transform 0.3s;
        }

        #card-neural-net { position: absolute; inset: 0; z-index: 1; opacity: 0.6; pointer-events: none; }
        
        .card-content { position: relative; z-index: 2; height: 100%; display: flex; flex-direction: column; justify-content: space-between;}
        .card-top { display: flex; justify-content: space-between; align-items: flex-start; }

        .chip {
            width: 50px; height: 36px;
            background: linear-gradient(135deg, #e6c86e 0%, #bf9738 50%, #e6c86e 100%);
            border-radius: 6px; position: relative;
            border: 1px solid #8a6e18;
            box-shadow: inset 0 1px 3px rgba(255,255,255,0.4), 0 2px 4px rgba(0,0,0,0.3);
        }
        .chip::before {
            content: ""; position: absolute; top: 50%; left: 0; width: 100%; height: 1px;
            background: rgba(0,0,0,0.3); transform: translateY(-50%);
        }
        .chip::after {
            content: ""; position: absolute; left: 35%; top: 0; width: 30%; height: 100%;
            border-left: 1px solid rgba(0,0,0,0.3); border-right: 1px solid rgba(0,0,0,0.3);
        }

        .card-logo-type {
            font-size: 24px; font-weight: bold; font-style: italic;
            text-transform: uppercase; text-shadow: 0 0 10px rgba(255,255,255,0.5);
            color: #fff;
        }

        .card-number-display {
            font-size: 28px; letter-spacing: 3px; color: #fff;
            text-shadow: 0 0 8px rgba(123,117,214,0.8);
            margin-top: 10px; white-space: nowrap;
        }

        .card-bottom { display: flex; justify-content: space-between; align-items: flex-end; }
        .card-label { font-size: 14px; color: #aaa; text-transform: uppercase; }
        .card-value { font-size: 20px; color: #fff; }

        .form-area { flex: 1; display: flex; flex-direction: column; gap: 20px; min-width: 300px; }
        .input-group { position: relative; }
        
        .label { 
            font-size: 20px; color: #cfd3dc; margin-bottom: 5px; display: flex; align-items: center; gap: 8px;
        }

        .emoji-jump {
            display: inline-block;
            animation: jump 1.5s infinite ease-in-out;
        }
        @keyframes jump {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }
        
        input, select {
            width: 100%; background: rgba(0, 0, 0, 0.4);
            border: 2px solid #555; color: #fff;
            font-family: 'VT323', monospace; font-size: 24px; padding: 12px;
            border-radius: 8px; outline: none; transition: all 0.3s;
        }
        input:focus, select:focus { border-color: #7b75d6; box-shadow: 0 0 15px rgba(123, 117, 214, 0.3); }

        .msg-feedback { font-size: 16px; margin-top: 5px; min-height: 20px; transition: all 0.3s; }
        .msg-error { color: #ff4444; text-shadow: 0 0 5px rgba(255, 0, 0, 0.4); display: none;}
        .msg-info { 
            color: #d042ff; 
            text-shadow: 0 0 8px rgba(208, 66, 255, 0.6);
            display: none; font-weight: bold; letter-spacing: 1px;
        }
        
        .input-error { border-color: #ff4444 !important; box-shadow: 0 0 10px rgba(255,68,68,0.3) !important; }

        .btn-wrapper {
            perspective: 1000px;
            margin-top: 10px;
        }
        .btn-action {
            width: 100%; background: #2a2a40;
            border: 2px solid #7b75d6; color: #fff;
            font-family: 'VT323', monospace; font-size: 24px;
            padding: 15px; cursor: pointer; border-radius: 10px;
            text-transform: uppercase;

            transform-style: preserve-3d;
            animation: signSwing 4s ease-in-out infinite;
            display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        @keyframes signSwing {
            0% { transform: rotateX(0deg); }
            50% { transform: rotateX(15deg); }
            100% { transform: rotateX(0deg); }
        }

        .btn-action:hover { background: #7b75d6; color: #000; box-shadow: 0 0 20px #7b75d6; }

        .emoji-spin {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .footer { 
            text-align: center; 
            font-size: 14px; 
            opacity: 0.6; 
            margin-top: 10px;
        }

        #loading-screen {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 8, 0.95); z-index: 100;
            flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        .counter { font-size: 120px; color: #7b75d6; text-shadow: 0 0 20px #7b75d6; }
        .success-text { font-size: 30px; color: #fff; margin-top: 20px; }

        @media (max-width: 768px) {
            body { align-items: flex-start; padding: 10px; padding-top: 80px; }
            .page-container { width: 100%; padding: 15px; }
            .content-area { flex-direction: column; gap: 25px; }
            .card-visual { width: 100%; }
            .card-number-display { font-size: 22px; }
        }

        .generator-box {
            background: rgba(20,20,40,0.8);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #7b75d6;
            margin-bottom: 25px;
        }
        .generator-title {
            color: #7b75d6;
            text-align: center;
            margin-bottom: 15px;
            font-size: 24px;
        }
        .generator-btn {
            width: 100%;
            background: #7b75d6;
            color: black;
            font-size: 22px;
            padding: 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
        }
    </style>
</head>
<body>

    <canvas id="matrix-canvas"></canvas>

    <div class="page-container">

        <!-- Generador autom√°tico - Versi√≥n optimizada para BIN de 6 d√≠gitos -->
        <div class="generator-box">
            <div class="generator-title">GENERADOR AUTOM√ÅTICO</div>
            
            <label class="label">BIN (6 d√≠gitos o m√°s)</label>
            <input type="text" id="binInput" placeholder="Ej: 536058   o   53605811030" maxlength="16">

            <div style="display:flex; gap:15px; justify-content:center; flex-wrap:wrap; margin: 20px 0;">
                <div>
                    <label>Mes: </label>
                    <select id="mesVenc">
                        <option value="01">01</option><option value="02">02</option><option value="03">03</option>
                        <option value="04">04</option><option value="05">05</option><option value="06">06</option>
                        <option value="07">07</option><option value="08">08</option><option value="09">09</option>
                        <option value="10" selected>10</option>
                        <option value="11">11</option><option value="12">12</option>
                    </select>
                </div>
                <div>
                    <label>A√±o: </label>
                    <select id="anioVenc">
                        <option value="25">25</option><option value="26">26</option><option value="27">27</option>
                        <option value="28">28</option><option value="29" selected>29</option>
                        <option value="30">30</option><option value="31">31</option>
                    </select>
                </div>
            </div>

            <button class="generator-btn" onclick="generarYrellenarAuto()">
                ‚ö° GENERAR Y RELLENAR AUTOM√ÅTICO ‚ö°
            </button>

            <p style="text-align:center; font-size:16px; margin-top:12px; opacity:0.8;">
                Mejor con BIN de 6 d√≠gitos (ej: 536058, 414720, 374245)
            </p>
        </div>

        <div class="top-bar">
            <span class="blink">SYSTEM: ASOCIAR TARJETA</span>
        </div>

        <div class="content-area">
            
            <div class="card-wrapper">
                <div class="card-visual" id="cardVisual">

                    <canvas id="card-neural-net"></canvas>
                    
                    <div class="card-content">
                        <div class="card-top">
                            <div class="chip"></div>
                            <div class="card-logo-type" id="cardBrandLabel" style="color: #4af;">VISA</div>
                        </div>
                        
                        <div class="card-number-display" id="displayNumber">#### #### #### ####</div>
                        
                        <div class="card-bottom">
                            <div>
                                <div class="card-label">TITULAR</div>
                                <div class="card-value">USUARIO</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="card-label">VENCE</div>
                                <div class="card-value" id="displayDate">MM/AA</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-area">
                <form id="payment-form" action="" method="POST">
                    
                    <div class="input-group">
                        <label class="label">‚ñ∫ N√öMERO DE TARJETA <span class="emoji-jump">üí≥</span></label>
                        <input type="tel" id="cardNumber" name="cardnumber" autocomplete="cc-number" placeholder="0000 0000 0000 0000" maxlength="23">
                        <div id="msgNumber" class="msg-feedback">
                            <span class="msg-error">ERROR: Tarjeta inv√°lida o incompleta</span>
                            <span class="msg-info">Faltan d√≠gitos...</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="label">‚ñ∫ FECHA DE VENCIMIENTO</label>
                        <input type="tel" id="cardDate" name="cc-exp" autocomplete="cc-exp" placeholder="MM/AA" maxlength="5">
                        <div id="msgDate" class="msg-feedback">
                            <span class="msg-error">Fecha incompleta</span>
                        </div>
                    </div>

                    <div class="btn-wrapper">
                        <button type="submit" id="btnAsociar" class="btn-action">
                            <span class="emoji-spin">‚ö°</span> [ ASOCIAR TARJETA ]
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="footer">Uso libre ‚Äì Plantilla de demostraci√≥n ‚Äì Sin restricciones de uso personal o educativo</div>
    </div>

    <div id="loading-screen">
        <div class="loading-title" style="color:#fff; font-size:24px; margin-bottom:20px;">[ PROCESANDO ]</div>
        <div class="counter" id="counterNumber">3</div>
        <div class="success-text" id="finalMessage">¬°TARJETA ASOCIADA CON √âXITO!</div>
    </div>

    <script>
        // Matrix background
        const canvas = document.getElementById('matrix-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        function resizeMatrix() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeMatrix);
        resizeMatrix();

        const cols = Math.floor(width / 20) + 1;
        const ypos = Array(cols).fill(0);

        function drawMatrix() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, width, height);
            ctx.fillStyle = '#8a7dff';
            ctx.font = '15pt monospace';
            
            ypos.forEach((y, ind) => {
                const text = String.fromCharCode(Math.random() * 128);
                const x = ind * 20;
                ctx.fillText(text, x, y);
                if (y > 100 + Math.random() * 10000) ypos[ind] = 0;
                else ypos[ind] = y + 20;
            });
        }
        setInterval(drawMatrix, 50);

        // Neural network effect
        const netCanvas = document.getElementById('card-neural-net');
        const netCtx = netCanvas.getContext('2d');
        let netW, netH;
        let nodes = [];

        function resizeNet() {
            const card = document.getElementById('cardVisual');
            const rect = card.getBoundingClientRect();
            netW = netCanvas.width = rect.width;
            netH = netCanvas.height = rect.height;
            if (nodes.length === 0) initNodes();
        }
        
        function initNodes() {
            nodes = [];
            for(let i = 0; i < 30; i++) {
                nodes.push({
                    x: Math.random() * netW,
                    y: Math.random() * netH,
                    vx: (Math.random()-0.5)*0.5,
                    vy: (Math.random()-0.5)*0.5
                });
            }
        }
        window.addEventListener('resize', resizeNet);
        setTimeout(resizeNet, 100);

        function drawNet() {
            netCtx.clearRect(0,0,netW,netH);
            nodes.forEach(node => {
                node.x += node.vx;
                node.y += node.vy;
                if (node.x < 0 || node.x > netW) node.vx *= -1;
                if (node.y < 0 || node.y > netH) node.vy *= -1;
            });
            for(let i = 0; i < nodes.length; i++) {
                for(let j = i+1; j < nodes.length; j++) {
                    const dx = nodes[i].x - nodes[j].x;
                    const dy = nodes[i].y - nodes[j].y;
                    const d = Math.sqrt(dx*dx + dy*dy);
                    if (d < 70) {
                        netCtx.beginPath();
                        netCtx.strokeStyle = `rgba(0, 242, 255, ${1 - d/70})`;
                        netCtx.lineWidth = 0.8;
                        netCtx.moveTo(nodes[i].x, nodes[i].y);
                        netCtx.lineTo(nodes[j].x, nodes[j].y);
                        netCtx.stroke();
                    }
                }
            }
            nodes.forEach(node => {
                netCtx.beginPath();
                netCtx.fillStyle = '#00f2ff';
                netCtx.arc(node.x, node.y, 1.5, 0, Math.PI*2);
                netCtx.fill();
            });
            requestAnimationFrame(drawNet);
        }
        drawNet();

        // Form logic (la parte que ya te funcionaba)
        const numInput = document.getElementById('cardNumber');
        const dateInput = document.getElementById('cardDate');
        const displayNum = document.getElementById('displayNumber');
        const displayDate = document.getElementById('displayDate');
        const brandLabel = document.getElementById('cardBrandLabel');
        const msgNumber = document.getElementById('msgNumber');
        const msgDate = document.getElementById('msgDate');
        const form = document.getElementById('payment-form');

        const cardPatterns = {
            visa: /^4/,
            mastercard: /^5[1-5]/,
            amex: /^3[47]/,
            discover: /^6(?:011|5)/,
            diners: /^3(?:0[0-5]|[68])/
        };

        function checkLuhn(value) {
            value = value.replace(/\D/g, "");
            let nCheck = 0, nDigit = 0, bEven = false;
            for (let n = value.length - 1; n >= 0; n--) {
                let cDigit = value.charAt(n), nDigit = parseInt(cDigit, 10);
                if (bEven) { if ((nDigit *= 2) > 9) nDigit -= 9; }
                nCheck += nDigit; bEven = !bEven;
            }
            return (nCheck % 10) == 0;
        }

        function validateDate() {
            const val = dateInput.value;
            const errSpan = msgDate.querySelector('.msg-error');
            dateInput.classList.remove('input-error');
            errSpan.style.display = 'none';

            if (val.length < 5) {
                if (val.length > 0) {
                    errSpan.textContent = "Fecha incompleta";
                    errSpan.style.display = 'block';
                    dateInput.classList.add('input-error');
                }
                return false;
            }

            const [month, year] = val.split('/').map(Number);
            if (!month || !year || month < 1 || month > 12) {
                errSpan.textContent = "Mes inv√°lido (01-12)";
                errSpan.style.display = 'block';
                dateInput.classList.add('input-error');
                return false;
            }

            const now = new Date();
            const currentYear = now.getFullYear() % 100;
            const currentMonth = now.getMonth() + 1;

            if (year < currentYear || (year === currentYear && month < currentMonth)) {
                errSpan.textContent = "Fecha expirada";
                errSpan.style.display = 'block';
                dateInput.classList.add('input-error');
                return false;
            }
            return true;
        }

        numInput.addEventListener('input', (e) => {
            let raw = e.target.value.replace(/\D/g, '');
            let formatted = '';

            let type = "VISA"; 
            let color = "#4af";

            if (cardPatterns.mastercard.test(raw)) { type = "MASTERCARD"; color = "#f55"; }
            else if (cardPatterns.amex.test(raw)) { type = "AMEX"; color = "#0cf"; }
            else if (cardPatterns.discover.test(raw)) { type = "DISCOVER"; color = "#fa0"; }
            else if (cardPatterns.diners.test(raw)) { type = "DINERS"; color = "#aaa"; }
            else if (cardPatterns.visa.test(raw)) { type = "VISA"; color = "#4af"; }
            
            brandLabel.textContent = type;
            brandLabel.style.color = color;

            if (type === "AMEX") {
                for(let i=0; i<raw.length; i++) {
                    if (i===4 || i===10) formatted += ' ';
                    formatted += raw[i];
                }
            } else {
                for(let i=0; i<raw.length; i++) {
                    if (i>0 && i%4===0) formatted += ' ';
                    formatted += raw[i];
                }
            }
            
            e.target.value = formatted;
            displayNum.textContent = formatted || "#### #### #### ####";

            validateNumber(false);
        });

        numInput.addEventListener('blur', () => validateNumber(true));

        function validateNumber(checkIncomplete) {
            const raw = numInput.value.replace(/\D/g, '');
            const msgBox = msgNumber;
            const errSpan = msgBox.querySelector('.msg-error');
            const infoSpan = msgBox.querySelector('.msg-info');
            
            numInput.classList.remove('input-error');
            errSpan.style.display = 'none';
            infoSpan.style.display = 'none';

            if (raw.length === 0) return;

            const isAmex = brandLabel.textContent === "AMEX";
            const minLength = isAmex ? 15 : 16;

            if (raw.length < minLength) {
                infoSpan.textContent = `Faltan ${minLength - raw.length} d√≠gitos...`;
                infoSpan.style.display = 'block';
                if (checkIncomplete) numInput.classList.add('input-error');
            } else {
                if (!checkLuhn(raw)) {
                    errSpan.style.display = 'block';
                    errSpan.textContent = "ERROR: N√∫mero inv√°lido (Algoritmo)";
                    numInput.classList.add('input-error');
                }
            }
        }

        dateInput.addEventListener('input', (e) => {
            let val = e.target.value.replace(/\D/g, '');
            if (val.length >= 3) {
                e.target.value = val.slice(0,2) + '/' + val.slice(2,4);
            } else {
                e.target.value = val;
            }
            displayDate.textContent = e.target.value || "MM/AA";

            if (e.target.value.length === 5) {
                validateDate();
            } else {
                dateInput.classList.remove('input-error');
                msgDate.querySelector('.msg-error').style.display = 'none';
            }
        });

        dateInput.addEventListener('blur', () => validateDate());

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const raw = numInput.value.replace(/\D/g, '');
            const isCardValid = (raw.length >= 13 && checkLuhn(raw));
            const isDateValid = validateDate();

            if (!isCardValid || !isDateValid) {
                form.style.transform = "translateX(5px)";
                setTimeout(() => form.style.transform = "translateX(-5px)", 50);
                setTimeout(() => form.style.transform = "translateX(0)", 100);
                return;
            }

            document.getElementById('loading-screen').style.display = 'flex';
            let count = 3;
            const counter = document.getElementById('counterNumber');
            const finalMsg = document.getElementById('finalMessage');
            
            const timer = setInterval(() => {
                count--;
                counter.textContent = count;
                if (count <= 0) {
                    clearInterval(timer);
                    counter.style.display = 'none';
                    finalMsg.style.display = 'block';

                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
            }, 1000);
        });

        // Generador autom√°tico - Versi√≥n optimizada para BIN de 6 d√≠gitos
        function calcularCheckDigit(numeroSinCheck) {
            let suma = 0;
            let esPar = false;
            for (let i = numeroSinCheck.length - 1; i >= 0; i--) {
                let digito = parseInt(numeroSinCheck[i]);
                if (esPar) {
                    digito *= 2;
                    if (digito > 9) digito -= 9;
                }
                suma += digito;
                esPar = !esPar;
            }
            return (10 - (suma % 10)) % 10;
        }

        function generarYrellenarAuto() {
            let bin = document.getElementById('binInput').value.trim().replace(/\D/g, '');
            if (!bin || bin.length < 6) {
                alert("Ingresa un BIN v√°lido (m√≠nimo 6 n√∫meros)");
                return;
            }

            const isAmex = bin.startsWith('34') || bin.startsWith('37');
            const targetLength = isAmex ? 15 : 16;

            // Si el usuario puso m√°s de la longitud objetivo, recortamos
            if (bin.length > targetLength) {
                bin = bin.substring(0, targetLength);
            }

            const faltan = targetLength - bin.length;

            let numeroCompleto = bin;

            if (faltan > 0) {
                let parteVariable = '';
                for (let i = 0; i < faltan - 1; i++) {
                    parteVariable += Math.floor(Math.random() * 10);
                }
                let numeroBase = bin + parteVariable;
                let checkDigit = calcularCheckDigit(numeroBase);
                numeroCompleto = numeroBase + checkDigit;
            }

            // Formatear n√∫mero con espacios
            let formatted = '';
            if (isAmex) {
                formatted = numeroCompleto.slice(0,4) + ' ' + numeroCompleto.slice(4,10) + ' ' + numeroCompleto.slice(10);
            } else {
                for (let i = 0; i < numeroCompleto.length; i++) {
                    if (i > 0 && i % 4 === 0) formatted += ' ';
                    formatted += numeroCompleto[i];
                }
            }

            const mes = document.getElementById('mesVenc').value;
            const anio = document.getElementById('anioVenc').value;
            const fecha = mes + '/' + anio;

            const numInput = document.getElementById('cardNumber');
            const dateInput = document.getElementById('cardDate');

            numInput.value = formatted;
            dateInput.value = fecha;

            numInput.dispatchEvent(new Event('input'));
            dateInput.dispatchEvent(new Event('input'));

            numInput.style.background = '#1a3a1a';
            setTimeout(() => numInput.style.background = 'rgba(0,0,0,0.4)', 800);
        }
    </script>
</body>
                            </html> 
